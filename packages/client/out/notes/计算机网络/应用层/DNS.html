<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>DNS | 0X1461A0</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/5db4aa1edde4971b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5db4aa1edde4971b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/38c642bc88044b6e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/38c642bc88044b6e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-2c644d3580cecc35.js" defer=""></script><script src="/_next/static/chunks/framework-325eacbb81921a43.js" defer=""></script><script src="/_next/static/chunks/main-c87967b003e3efc2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-111c29f79e705983.js" defer=""></script><script src="/_next/static/chunks/542-e750f8bef0aa06d2.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5B%5B...param%5D%5D-4c9f87d1f418ba6e.js" defer=""></script><script src="/_next/static/OyucwIrXZRgWNxoAUA9lF/_buildManifest.js" defer=""></script><script src="/_next/static/OyucwIrXZRgWNxoAUA9lF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen"><header class="pb-10 pt-12 text-center shrink-0"><a class="uppercase tracking-widest text-gray-600" href="/">0x1461a0</a></header><main class="flex-auto mb-12"><div class="TOC_table-of-content__KyR_J"><ul><li><a href="#DNS" data-target-id="h1-DNS-0">DNS</a><ul><li><a href="#域名层次" data-target-id="h2-域名层次-0">域名层次</a></li><li><a href="#工作原理" data-target-id="h2-工作原理-1">工作原理</a></li><li><a href="#DNS缓存" data-target-id="h2-DNS缓存-2">DNS缓存</a></li><li><a href="#DNS记录" data-target-id="h2-DNS记录-3">DNS记录</a></li></ul></li><li><a href="#CDN" data-target-id="h1-CDN-1">CDN</a><ul><li><a href="#主要原理" data-target-id="h2-主要原理-4">主要原理</a></li><li><a href="#CNAME" data-target-id="h2-CNAME-5">CNAME</a></li><li><a href="#实现CDN" data-target-id="h2-实现CDN-6">实现CDN</a></li></ul></li></ul></div><div class="article_article-container__yUBmR"><div class="mb-8"><h1 data-title="true" class="mb-0">DNS</h1><p class="opacity-50 !-mt-2"><span>Post: <!-- -->2022.09.18</span><span class="font-bold">·</span><span>Update: <!-- -->2022.09.18</span></p></div><h1>DNS</h1>
<p>域名系统（Domain Name System），提供了主机名到 IP 地址转换的目录服务。</p>
<p>严格来说，DNS 具有两层含义：</p>
<ol>
<li>由分层的 DNS 服务器实现的分布式<strong>数据库</strong></li>
<li>查询分布式数据库的<strong>应用层协议</strong>，DNS协议使用 UDP，端口号 53</li>
</ol>
<p>除了主机名到 IP 地址转换，DNS 还提供了其他服务：</p>
<ol>
<li>主机别名：主机可以拥有多个主机名(一个<strong>规范主机名</strong>，多个别名)，DNS 服务可以获取别名对应的 IP 和规范主机名</li>
<li>邮件服务器别名：和主机别名相同，邮件服务器也可以拥有别名便于记忆</li>
<li>负载分配：一个规范主机名可以对应多台服务器（多个IP），DNS 可以在这些 IP 地址集合中循环分配负载</li>
</ol>
<h2>域名层次</h2>
<p>DNS 也代指由分层的 DNS 服务器实现的分布式<strong>数据库</strong>，这些 DNS 服务器，它们以<strong>层次</strong>方式组织并分布在全世界范围</p>
<p>DNS 服务器存储着主机到 IP 的映射，这些映射分布在所有的 DNS 服务器上，每一台都仅存储一部分的映射。</p>
<p>DNS 服务器在层次上分为三种：</p>
<ol>
<li>根 DNS 服务器：根服务器遍及全球，根服务器提供的是 TLD 服务器的 IP</li>
<li>顶级域服务器（TLD）：每个顶级域都有对应的 TLD 服务器（或集群），TLD 服务器提供的是权威 DNS 服务器的 IP</li>
<li>权威 DNS 服务器：互联网中可访问的主机都需要在权威 DNS 服务器中保存主机名到主机 IP 的映射</li>
</ol>
<p><strong>本地 DNS 服务器</strong></p>
<p>在 DNS 服务器层次之外存在着一类至关重要的 DNS 服务器：本地 DNS  服务器。</p>
<p>每个 ISP 都会有一台或多台本地 DNS  服务器，当和某个 ISP 相连通过 DHCP 分配 IP 地址时，会提供一台或多台本地 DNS 服务器的 IP。</p>
<p>当我们进行访问某个网站时，会先将主机名发送给本地 DNS 服务器，接着本地 DNS 服务器会依次向根服务器、顶级域服务器、权威 DNS 服务器进行询问，最后将该主机名对应的 IP 返回给我们。</p>
<h2>工作原理</h2>
<p>DNS 查询的方式有两种：</p>
<ul>
<li>递归查询</li>
<li>迭代查询</li>
</ul>
<p>就类似于递归算法和迭代算法一样，递归查询就是我询问你，你得给我答案，你如果不知道的话你得接着问别人</p>
<p>一般来说，<strong>域名服务器之间的查询使用迭代查询方式，以免根域名服务器的压力过大</strong></p>
<p>所以通常来说向本地 DNS 服务器的查询是<strong>递归查询</strong>，本地 DNS 服务器向其他域名服务器的查询是<strong>迭代查询</strong>。</p>
<h2>DNS缓存</h2>
<p>为了改善时延性能并减少因特网到处传输 DNS 报文，DNS 广泛的使用了缓存技术。</p>
<p>在一个请求链中，当某个 DNS  服务器接收到一个 DNS 回答，则会将该回答缓存在本地，后序查询会直接返回缓存。</p>
<p>因为缓存的存在，很多时候根服务器都被绕过了。</p>
<p>计算机中 DNS 记录在本地有两种缓存方式：</p>
<ol>
<li><strong>浏览器缓存</strong>
<ul>
<li>浏览器在获取网站域名的实际 IP 地址后会对其进行缓存，减少网络请求的损耗</li>
<li>每种浏览器都有一个固定的 DNS 缓存时间，Chrome 的过期时间是 1 分钟</li>
</ul>
</li>
<li><strong>操作系统缓存</strong>
<ul>
<li>用户自己配置的 hosts 文件也属于操作系统的 DNS 缓存</li>
</ul>
</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/668392324cbe4c12b66d77ddbfcd25cc~tplv-k3u1fbpfcp-watermark.awebp" alt=""/></p>
<h2>DNS记录</h2>
<p>DNS 分布式数据库存储的映射被称为<strong>资源记录</strong>，每个 DNS 回答报文中包含了一条或多条资源记录。</p>
<p>资源记录一个4元组：<code>(Name, Value, Type, TTL)</code></p>
<p>TTL 记录的是生存时间，而 Name 和 Value 字段的值和含义取决于 Type 字段：</p>
<ul>
<li>Type = A，表示的这个资源记录提供的是主机名到 IP 地址的映射，Name = 主机名，Value = IP地址</li>
<li>Type = NS，则 Name = 域，Value = 能够获得该域中主机 IP 的 DNS 服务器的<strong>主机名</strong></li>
<li>Type = CNAME，则 Name = 别名，Value = 别名为 Name 的主机对应的<strong>规范主机名</strong></li>
<li>Type = MX，Name = 别名，Value = 别名为 Name 的<strong>邮件</strong>服务器的<strong>规范主机名</strong></li>
</ul>
<p><img src="https://oss.xiefeng.tech/images/20210925084656.png" alt=""/></p>
<p>一台权威 DNS 服务器会包含一条用于该（特定）主机名的类型 A 记录，其他的服务器也可能在缓存中包含这样一条记录。</p>
<p>如果服务器不是用于某主机名的权威 DNS 服务器，则该服务器会包含一条类型 NS 记录和一条类型 A 记录：</p>
<ul>
<li>NS 记录：包含该主机名所属的<strong>域</strong>和其该域所对应的 DNS 服务器主机名</li>
<li>A 记录：DNS 服务器主机名和其对应的 IP</li>
</ul>
<p>例如：一台 edu 顶级域 DNS 服务器不是 gaia.cs.umass.edu 的权威 DNS 服务器，则该顶级域服务器会包含一条 NS 类型记录和一条 A 类型记录：</p>
<ul>
<li>NS 类型记录：(umass.edu, dns.umass.edu, NS)</li>
<li>A 类型记录：(dns,umass.edu, xxx.xxx.xxx.xxx, A)</li>
</ul>
<h1>CDN</h1>
<p>CDN 的全称是 Content Delivery Network，即内容分发网络。</p>
<p>CDN 管理分布在多个地理位置上的服务器（CDN节点），服务器中存储着资源的副本，并试图将每个用户的请求定向到一个用户体验最好的 CDN 节点上。</p>
<p>解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点 加速、点播、直播等场景。</p>
<h2>主要原理</h2>
<p>当用户主机请求一个地址时，CDN 必须截获该请求并执行操作：</p>
<ol>
<li>确定此时适合用于该客户的 CDN 服务器集群</li>
<li>将客户的请求重定向到该集群的某台服务器</li>
</ol>
<p>所以 CDN 需要截获和重定向请求，大多数 CDN 利用 DNS 来截获和重定向请求。</p>
<p>CDN 对域名解析过程进行了调整，对应的权威 DNS 服务器返回的不是 IP 地址而是某个 CDN 域的主机名（CNAME 记录）</p>
<p>本地服务器会对该服务器发起 DNS 请求，这时就进入了 CDN 专用 DNS 基础设施，此时会返回最适合的服务器的 IP 地址。</p>
<h2>CNAME</h2>
<p>CNAME：别名记录，也称为规范主机名，这种记录允许将多个名字映射到同一台计算机</p>
<p>例如，有一台服务器的主机名为 <code>host.mydomain.com</code>，它需要同时提供WWW和MAIL服务，为了用户的方便，可以为该计算机设置两个别名：<code>www.mydomain.com</code> 和 <code>mail.mydomain.com</code></p>
<p>所以在 DNS 服务中会有这样的记录：</p>
<ol>
<li>A类型：<code>host.mydomain.com</code> 指向 xxx.xxx.xxx.xx</li>
<li>CNAME类型：<code>www.mydomain.com </code> 指向 <code>host.mydomain.com</code></li>
<li>CNAME类型：<code>mail.mydomain.com </code> 指向 <code>host.mydomain.com</code></li>
</ol>
<p>wiki 中描述当一个DNS解析服务器在查询各类记录时遇到一则CNAME记录时，它会立即重启查询，查询所映射到域名的对应记录。</p>
<p>但是使用 dig 测试查看，会有一个 query 两个 answer</p>
<p><img src="https://oss.xiefeng.tech/images/20210925093953.png" alt=""/></p>
<h2>实现CDN</h2>
<p>最简单的 CDN 网络由一个 DNS 服务器和几台缓存服务器组成：</p>
<ol>
<li>当用户发起请求时，DNS 系统将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器</li>
<li>CDN 的 DNS 服务器将 CDN 的全局负载均衡设备地址返回用户</li>
<li>用户向 CDN 的全局负载均衡设备发起请求</li>
<li>CDN 全局负载均衡设备根据用户 IP 地址等信息，将最适合的 CDN 节点地址回应给本地 DNS</li>
<li>本地 DNS 将该地址返回给客户端</li>
</ol><div><a href="/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BA%94%E7%94%A8%E5%B1%82">cd ..</a></div></div></main><footer class="pb-2 pt-12 text-center shrink-0"><div class="capitalize">copyright <span class="text-2xl align-middle">©</span> <!-- -->2022<!-- --> xie feng</div><div class="text-sm">Powered by NextJS</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metaTitle":"DNS","article":{"title":"DNS","content":"# DNS\r\n\r\n域名系统（Domain Name System），提供了主机名到 IP 地址转换的目录服务。\r\n\r\n严格来说，DNS 具有两层含义：\r\n\r\n1. 由分层的 DNS 服务器实现的分布式**数据库**\r\n2. 查询分布式数据库的**应用层协议**，DNS协议使用 UDP，端口号 53\r\n\r\n除了主机名到 IP 地址转换，DNS 还提供了其他服务：\r\n\r\n1. 主机别名：主机可以拥有多个主机名(一个**规范主机名**，多个别名)，DNS 服务可以获取别名对应的 IP 和规范主机名\r\n2. 邮件服务器别名：和主机别名相同，邮件服务器也可以拥有别名便于记忆\r\n3. 负载分配：一个规范主机名可以对应多台服务器（多个IP），DNS 可以在这些 IP 地址集合中循环分配负载\r\n\r\n## 域名层次\r\n\r\nDNS 也代指由分层的 DNS 服务器实现的分布式**数据库**，这些 DNS 服务器，它们以**层次**方式组织并分布在全世界范围\r\n\r\nDNS 服务器存储着主机到 IP 的映射，这些映射分布在所有的 DNS 服务器上，每一台都仅存储一部分的映射。\r\n\r\nDNS 服务器在层次上分为三种：\r\n\r\n1. 根 DNS 服务器：根服务器遍及全球，根服务器提供的是 TLD 服务器的 IP\r\n2. 顶级域服务器（TLD）：每个顶级域都有对应的 TLD 服务器（或集群），TLD 服务器提供的是权威 DNS 服务器的 IP\r\n3. 权威 DNS 服务器：互联网中可访问的主机都需要在权威 DNS 服务器中保存主机名到主机 IP 的映射\r\n\r\n**本地 DNS 服务器**\r\n\r\n在 DNS 服务器层次之外存在着一类至关重要的 DNS 服务器：本地 DNS  服务器。\r\n\r\n每个 ISP 都会有一台或多台本地 DNS  服务器，当和某个 ISP 相连通过 DHCP 分配 IP 地址时，会提供一台或多台本地 DNS 服务器的 IP。\r\n\r\n当我们进行访问某个网站时，会先将主机名发送给本地 DNS 服务器，接着本地 DNS 服务器会依次向根服务器、顶级域服务器、权威 DNS 服务器进行询问，最后将该主机名对应的 IP 返回给我们。\r\n\r\n## 工作原理\r\n\r\nDNS 查询的方式有两种：\r\n\r\n- 递归查询\r\n- 迭代查询\r\n\r\n就类似于递归算法和迭代算法一样，递归查询就是我询问你，你得给我答案，你如果不知道的话你得接着问别人\r\n\r\n一般来说，**域名服务器之间的查询使用迭代查询方式，以免根域名服务器的压力过大**\r\n\r\n所以通常来说向本地 DNS 服务器的查询是**递归查询**，本地 DNS 服务器向其他域名服务器的查询是**迭代查询**。\r\n\r\n## DNS缓存\r\n\r\n为了改善时延性能并减少因特网到处传输 DNS 报文，DNS 广泛的使用了缓存技术。\r\n\r\n在一个请求链中，当某个 DNS  服务器接收到一个 DNS 回答，则会将该回答缓存在本地，后序查询会直接返回缓存。\r\n\r\n因为缓存的存在，很多时候根服务器都被绕过了。\r\n\r\n计算机中 DNS 记录在本地有两种缓存方式：\r\n\r\n1. **浏览器缓存**\r\n   - 浏览器在获取网站域名的实际 IP 地址后会对其进行缓存，减少网络请求的损耗\r\n   - 每种浏览器都有一个固定的 DNS 缓存时间，Chrome 的过期时间是 1 分钟\r\n2. **操作系统缓存**\r\n   - 用户自己配置的 hosts 文件也属于操作系统的 DNS 缓存\r\n\r\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/668392324cbe4c12b66d77ddbfcd25cc~tplv-k3u1fbpfcp-watermark.awebp)\r\n\r\n## DNS记录\r\n\r\nDNS 分布式数据库存储的映射被称为**资源记录**，每个 DNS 回答报文中包含了一条或多条资源记录。\r\n\r\n资源记录一个4元组：`(Name, Value, Type, TTL)`\r\n\r\nTTL 记录的是生存时间，而 Name 和 Value 字段的值和含义取决于 Type 字段：\r\n\r\n- Type = A，表示的这个资源记录提供的是主机名到 IP 地址的映射，Name = 主机名，Value = IP地址\r\n- Type = NS，则 Name = 域，Value = 能够获得该域中主机 IP 的 DNS 服务器的**主机名**\r\n- Type = CNAME，则 Name = 别名，Value = 别名为 Name 的主机对应的**规范主机名**\r\n- Type = MX，Name = 别名，Value = 别名为 Name 的**邮件**服务器的**规范主机名**\r\n\r\n![](https://oss.xiefeng.tech/images/20210925084656.png)\r\n\r\n一台权威 DNS 服务器会包含一条用于该（特定）主机名的类型 A 记录，其他的服务器也可能在缓存中包含这样一条记录。\r\n\r\n如果服务器不是用于某主机名的权威 DNS 服务器，则该服务器会包含一条类型 NS 记录和一条类型 A 记录：\r\n\r\n- NS 记录：包含该主机名所属的**域**和其该域所对应的 DNS 服务器主机名\r\n- A 记录：DNS 服务器主机名和其对应的 IP\r\n\r\n例如：一台 edu 顶级域 DNS 服务器不是 gaia.cs.umass.edu 的权威 DNS 服务器，则该顶级域服务器会包含一条 NS 类型记录和一条 A 类型记录：\r\n\r\n- NS 类型记录：(umass.edu, dns.umass.edu, NS)\r\n- A 类型记录：(dns,umass.edu, xxx.xxx.xxx.xxx, A)\r\n\r\n# CDN\r\n\r\nCDN 的全称是 Content Delivery Network，即内容分发网络。\r\n\r\nCDN 管理分布在多个地理位置上的服务器（CDN节点），服务器中存储着资源的副本，并试图将每个用户的请求定向到一个用户体验最好的 CDN 节点上。\r\n\r\n解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点 加速、点播、直播等场景。\r\n\r\n## 主要原理\r\n\r\n当用户主机请求一个地址时，CDN 必须截获该请求并执行操作：\r\n\r\n1. 确定此时适合用于该客户的 CDN 服务器集群\r\n2. 将客户的请求重定向到该集群的某台服务器\r\n\r\n所以 CDN 需要截获和重定向请求，大多数 CDN 利用 DNS 来截获和重定向请求。\r\n\r\nCDN 对域名解析过程进行了调整，对应的权威 DNS 服务器返回的不是 IP 地址而是某个 CDN 域的主机名（CNAME 记录）\r\n\r\n本地服务器会对该服务器发起 DNS 请求，这时就进入了 CDN 专用 DNS 基础设施，此时会返回最适合的服务器的 IP 地址。\r\n\r\n## CNAME\r\n\r\nCNAME：别名记录，也称为规范主机名，这种记录允许将多个名字映射到同一台计算机\r\n\r\n例如，有一台服务器的主机名为 `host.mydomain.com`，它需要同时提供WWW和MAIL服务，为了用户的方便，可以为该计算机设置两个别名：`www.mydomain.com` 和 `mail.mydomain.com`\r\n\r\n所以在 DNS 服务中会有这样的记录：\r\n\r\n1. A类型：`host.mydomain.com` 指向 xxx.xxx.xxx.xx\r\n2. CNAME类型：`www.mydomain.com ` 指向 `host.mydomain.com`\r\n3. CNAME类型：`mail.mydomain.com ` 指向 `host.mydomain.com`\r\n\r\nwiki 中描述当一个DNS解析服务器在查询各类记录时遇到一则CNAME记录时，它会立即重启查询，查询所映射到域名的对应记录。\r\n\r\n但是使用 dig 测试查看，会有一个 query 两个 answer\r\n\r\n![](https://oss.xiefeng.tech/images/20210925093953.png)\r\n\r\n## 实现CDN\r\n\r\n最简单的 CDN 网络由一个 DNS 服务器和几台缓存服务器组成：\r\n\r\n1. 当用户发起请求时，DNS 系统将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器\r\n2. CDN 的 DNS 服务器将 CDN 的全局负载均衡设备地址返回用户\r\n3. 用户向 CDN 的全局负载均衡设备发起请求\r\n4. CDN 全局负载均衡设备根据用户 IP 地址等信息，将最适合的 CDN 节点地址回应给本地 DNS\r\n5. 本地 DNS 将该地址返回给客户端\r\n\r\n\r\n\r\n","meta":{"size":7436,"birthTime":1663496641441.1855,"updateTime":1663496641441.536}}},"__N_SSG":true},"page":"/notes/[[...param]]","query":{"param":["计算机网络","应用层","DNS"]},"buildId":"OyucwIrXZRgWNxoAUA9lF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>